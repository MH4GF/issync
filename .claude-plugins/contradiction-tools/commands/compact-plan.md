# /compact-plan: plan.md圧縮コマンド

あなたは矛盾解消駆動開発を実践するAIエージェントです。このコマンドは、plan.mdファイルが大きくなりすぎた際に、情報量を保持したまま文量を削減する圧縮を行います。

## 使用方法

```bash
/compact-plan                    # 引数なし: .issync/state.ymlから選択
/compact-plan <file_path>        # 明示的パス指定（後方互換性）
```

**引数**:
- `file_path` (オプション): 圧縮するplan.mdファイルのパス
  - 省略時: `.issync/state.yml`から同期中のファイルを選択
  - 明示的指定: `/compact-plan docs/plan.md`

## 実行フロー

### 1. state.ymlの確認と選択

**引数が指定されている場合**: そのパスを使用し、このステップをスキップして次へ進んでください。

**引数が指定されていない場合**: `.issync/state.yml`を読み込み、同期中のファイル一覧を表示してください。

**state.ymlが存在しない/syncsが空の場合**:
```
エラー: .issync/state.ymlが見つからないか、同期中のファイルがありません。
明示的にパスを指定してください: /compact-plan <file_path>
```

**複数ファイルがある場合**: 選択を促してください
```
圧縮対象のplan.mdを選択してください:
1. .issync/docs/task-dashboard.md (最終同期: 2025-10-14T08:20:50Z, Issue: route06/liam-internal/issues/5829)
2. docs/plan.md (最終同期: 2025-10-14T07:07:44Z, Issue: MH4GF/issync/issues/1)

番号を入力してください (1-2):
```

**1つのみの場合**: 確認を表示して自動選択
```
圧縮対象: .issync/docs/task-dashboard.md
  最終同期: 2025-10-14T08:20:50Z
  Issue: route06/liam-internal/issues/5829

このファイルを圧縮しますか? (y/n)
```

### 2. plan.mdの読み込みと分析

指定されたplan.mdファイルを読み込み、以下を分析してください：
- 総行数
- 各セクションの行数
- 重複している内容
- 完了済みのPhaseとタスク
- 解決済みのOpen Questions
- 矛盾する記述

### 3. plan-template.mdとの比較

公式テンプレート（`https://raw.githubusercontent.com/MH4GF/issync/refs/heads/main/docs/plan-template.md`）を取得し、以下を確認・修正してください：
- セクション順序がテンプレートと一致しているか → 不一致の場合は並び替え
- 各セクションの「📝 記入タイミング」「✍️ 記入内容」ガイダンスがテンプレートと完全一致しているか → 不一致の場合はテンプレートの文言に更新
- 不要なカスタムセクションがないか → **テンプレートに存在しないセクションは削除**（内容が重要な場合は適切なセクションに統合）

**テンプレート準拠の価値**:
ガイダンスをテンプレートと完全一致させることで、AIエージェントが「今何を書くべきか」を迷わず判断できるようになり、作業効率が大幅に向上します。カスタムセクションの削除により、情報の一元化とメンテナンス性が改善されます。

### 4. 圧縮処理

以下の観点で圧縮を実行してください：

#### a) テンプレート準拠性の修正（最優先）
- **セクション順序をテンプレートに合わせる**: 並び順が異なる場合は、テンプレート通りの順序に並び替え
- **ガイダンス文言をテンプレートと完全一致させる**: 「📝 記入タイミング」「✍️ 記入内容」の文言をテンプレートからコピーして上書き（内容の微妙な差異も統一）
- **不要なカスタムセクションを削除**: テンプレートに存在しないセクションは削除し、重要な内容は適切なセクションに統合
- **ガイダンスに沿わない記述を適切なセクションに移動**: 例えば「Specification」に書くべき内容が「Purpose」に書かれている場合は移動

#### b) 重複情報の削減
- 同じ内容が複数セクションで繰り返されている場合、参照形式に変換
- 例: 「詳細はSpecificationセクション参照」

#### c) 解決済みOpen Questionsの整理
- ✅ 解決済みマークのついたOpen Questionsを「解決済み（アーカイブ）」セクションに移動
- または、Decision Logへの参照のみ残して削除

#### d) 完了済みPhaseの簡潔化
- 完了したPhaseのタスク詳細をOutcomes & Retrospectivesに統合
- Work Planでは要約のみ残す

例:
```markdown
### Phase 1: ✅ 完了 (2025-10-14)
**ゴール**: [簡潔な説明]
**成果**: Outcomes & Retrospectives 参照
```

#### e) 冗長な説明の簡潔化
- 長文を箇条書きに変換
- 過剰に詳細な説明を要約
- 大きな図表や詳細仕様は外部ファイル化を提案（実行はしない）

#### f) 完了済みタスクの整理
- Tasksセクションから✅完了済みタスクを削除
- 完了内容はOutcomes & Retrospectivesに統合されているか確認

### 5. 矛盾検出と報告

以下のような矛盾を検出し、ユーザーに報告してください：
- Decision Logで矛盾する決定（例: 「A採用」→後で「Bに変更」だが撤回理由が不明確）
- Work PlanとTasksセクションで内容が一致しない
- Acceptance CriteriaとValidation & Acceptance Criteriaで基準が異なる
- Open QuestionsとDecision Logで同じ質問が両方に存在

矛盾を発見した場合、Open Questionsに追加する提案をしてください。

### 6. 圧縮後のplan.mdを保存

圧縮処理を適用したplan.mdを保存してください。

**注意**: issyncを使用している場合は、watchモードがバックグラウンドで起動していれば自動的にGitHub Issueに同期されます。明示的な`push`コマンドやバックアップ作成は不要です。

## 出力形式

圧縮完了後、以下の形式でレポートを出力してください：

```markdown
## /compact-plan 実行結果

### 圧縮サマリー
- 文量: [元の行数]行 → [圧縮後の行数]行（[削減率]%削減）
- 削除した重複: [件数]箇所
- 整理したOpen Questions: [件数]件（解決済み）
- 簡潔化したPhase: Phase [X]（[行数]行 → [行数]行）
- 完了タスク削除: [件数]件

### 適用した圧縮処理
- ✅ テンプレート準拠性の修正
  - セクション順序の並び替え: [変更有無]
  - ガイダンス文言の完全一致: [更新したセクション数]箇所
  - カスタムセクション削除: [削除したセクション名]（[件数]件）
- ✅ 重複情報の削減（[件数]箇所）
- ✅ 解決済みOpen Questions整理（[件数]件）
- ✅ 完了Phase簡潔化（Phase [X]）
- ✅ 冗長な説明の簡潔化（[件数]箇所）
- ✅ 完了タスク削除（[件数]件）

### ⚠️ 矛盾検出
[矛盾が検出された場合のみ表示]
- 矛盾1: [詳細な説明]
  - 場所: [セクション名]
  - 推奨対応: [対処方法]
- 矛盾2: [詳細な説明]
  - 場所: [セクション名]
  - 推奨対応: [対処方法]

### 次のアクション
- [ ] 圧縮結果をレビュー
- [ ] 矛盾が検出された場合は解消してください
```

## 重要な注意事項

1. **テンプレート準拠が最優先**: セクション順序とガイダンス文言は必ずテンプレートと完全一致させること。これによりAIエージェントの作業効率が大幅に向上する
2. **カスタムセクションは削除**: テンプレートに存在しないセクションは削除し、重要な内容は適切なセクションに統合すること
3. **情報量は変えない**: 削減するのは文量のみで、情報は失わないこと
4. **矛盾は報告のみ**: 矛盾を勝手に解消せず、ユーザーに報告して判断を仰ぐこと
5. **外部ファイル化は提案のみ**: 大きな図表や詳細仕様の外部ファイル化は実行せず、提案のみ行うこと
6. **issync自動同期**: issyncのwatchモードが起動している場合は自動的に同期されるため、明示的なpushやバックアップは不要

## 実行を開始

それでは、上記のフローに従ってplan.mdの圧縮を開始してください。
