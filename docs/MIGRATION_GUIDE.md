# plan-template.md Migration Guide

このドキュメントは、plan-template.mdのバージョン間の変更内容とマイグレーション手順を記録します。

## バージョン管理の方針

- **バージョン番号**: 単純な整数（1, 2, 3...）を使用
- **日付**: バージョン番号と共に日付を併記（例: `<!-- Template Version: 1 (2025-10-15) -->`）
- **マイグレーション**: このガイドを参照して、既存のplan.mdを新しいバージョンに更新

## Version 1 (2025-10-15)

### 変更内容

**初期バージョン**: 矛盾解消駆動開発ワークフローに最適化されたplan-template.mdの初版

**主な特徴:**
- 11セクション構成（Purpose/Overview、Tasks、Open Questions、Decision Log等）
- 各セクションに記入タイミングガイダンス（HTMLコメント形式）
- 更新ガイドライン（「✅ DO」「❌ DON'T」形式）
- AIガイダンスをHTMLコメント化（人間には非表示）

### マイグレーション手順

初期バージョンのため、マイグレーション手順はありません。

新規プロジェクトで使用する場合:
```bash
issync init --template
```

---

## Version 2 (2025-10-15)

### 変更内容

**概要**: Open Questions セクションのカテゴリ構造を削除し、質問をフラットに並べる構造に変更

**変更されたセクション:**
- **Open Questions / 残論点**: カテゴリ見出し（`### [カテゴリX]`）を削除し、質問を直接セクション内に配置する構造に変更

**理由:**
- カテゴリ構造は小規模なプロジェクトでは冗長であり、保守コストが高い
- 質問の優先度順に並べることで、実装者が重要な問いを見つけやすくなる
- テンプレートのシンプルさを維持し、プロジェクト間の一貫性を向上

### マイグレーション手順

#### 手動マイグレーション

既存のplan.mdのOpen Questionsセクションをバージョン2に移行する手順:

1. **カテゴリ見出しの削除**: `### [カテゴリ1]`, `### [カテゴリ2]` などの見出しを削除
2. **質問の再配置**: 質問（`**Q1: [質問のタイトル]**`）を優先度順に並べる
3. バージョンヘッダーを 2 に更新

**変更前:**
```markdown
## Open Questions / 残論点

### 実装詳細

**Q1: [質問のタイトル]**
- [質問の詳細]

### ドキュメント更新・運用

**Q2: [質問のタイトル]**
- [質問の詳細]
```

**変更後:**
```markdown
## Open Questions / 残論点

**Q1: [質問のタイトル]**
- [質問の詳細]

**Q2: [質問のタイトル]**
- [質問の詳細]
```

**注意事項:**
- 優先度が高い質問を上に配置することを推奨

---

## Version 3 (2025-10-15)

### 変更内容

**概要**: 更新ガイドラインをHTMLコメント化し、人間のレビュー時の可読性を向上

**変更されたセクション:**
- **更新ガイドライン**: 「## 🚨 このドキュメントの更新ガイドライン（必読）」セクション全体をHTMLコメント（`<!-- -->`）で囲み、人間には非表示に

**理由:**
- 人間がGitHub Issueでplan.mdを閲覧する際、AI向けガイダンスは視覚的なノイズとなり可読性を損なう
- HTMLコメント化により人間のレビュー時の可読性を最大化しつつ、AIエージェントは引き続き読み取り可能
- 他のセクションのAIガイダンスと統一した形式に（全てHTMLコメント化）

### マイグレーション手順

#### 手動マイグレーション

既存のplan.mdをバージョン3に移行する手順:

1. **更新ガイドラインのHTMLコメント化**: 「## 🚨 このドキュメントの更新ガイドライン（必読）」セクション全体（見出しから最後の`---`の直前まで）を `<!-- -->` で囲む
2. バージョンヘッダーを 3 に更新

**変更前:**
```markdown
この実行計画は生きたドキュメントです。新しい情報が出るたびに各セクションを更新してください。各セクションは、事前知識のない初めての貢献者へのガイダンスとして扱ってください。

---

## 🚨 このドキュメントの更新ガイドライン（必読）

**基本原則:**
（ガイドライン本文）

---

## Purpose / Overview
```

**変更後:**
```markdown
この実行計画は生きたドキュメントです。新しい情報が出るたびに各セクションを更新してください。各セクションは、事前知識のない初めての貢献者へのガイダンスとして扱ってください。

<!--
## 🚨 このドキュメントの更新ガイドライン（必読）

**基本原則:**
（ガイドライン本文）
-->

---

## Purpose / Overview
```

**注意事項:**
- セクション全体をHTMLコメントで囲む（`---`の前後の空行は維持）

---

## Version 4 (2025-10-15)

### 変更内容

**概要**: テンプレートにissyncマーカーを追加し、issync以外のツールから開始した場合にも対応

**追加された要素:**
- **issyncマーカー**: ファイルの先頭に `<!-- issync:v1:start -->`、末尾に `<!-- issync:v1:end -->` を追加

**理由:**
- issync以外のツール（手動でGitHub Issueに貼り付けた場合など）から開始した場合でも、issyncがコメントを自動発見できるようにする
- HTMLコメントなのでGitHub UIでは見えず、可読性に影響を与えない
- Template Versionコメントと同様、HTMLコメントをテンプレートに含めることに違和感がない
- テンプレートとリモートコメントの構造が最初から一致し、一貫性が向上

### マイグレーション手順

#### 手動マイグレーション

既存のplan.mdをバージョン4に移行する手順:

1. **先頭マーカーの追加**: ファイルの最初の行（Template Versionコメントの前）に `<!-- issync:v1:start -->` を追加
2. **末尾マーカーの追加**: ファイルの最後の行に `<!-- issync:v1:end -->` を追加
3. バージョンヘッダーを 4 に更新

**変更前:**
```markdown
<!-- Template Version: 3 (2025-10-15) -->

# [Project Name] Development Plan

この実行計画は生きたドキュメントです。...

（中略）

- [考慮事項1]
- [考慮事項2]
```

**変更後:**
```markdown
<!-- issync:v1:start -->
<!-- Template Version: 4 (2025-10-15) -->

# [Project Name] Development Plan

この実行計画は生きたドキュメントです。...

（中略）

- [考慮事項1]
- [考慮事項2]
<!-- issync:v1:end -->
```

**注意事項:**
- マーカーはHTMLコメントなので、GitHub UIでは表示されない
- マーカーがなくてもissyncは動作するが、追加することで互換性が向上

---

## Version 5 (2025-10-16)

### 変更内容

**概要**: TasksセクションのGitHub Issue連携ガイダンスをHTMLコメント化し、人間のレビュー時の可読性を向上

**変更されたセクション:**
- **Tasks**: GitHub Issue連携ガイダンス（タスク管理方針、記法説明）をAI向けガイダンスの一部としてHTMLコメント内に移動

**理由:**
- Version 3と同様の方針：AI向けガイダンスをHTMLコメント化し、人間のレビュー時の可読性を向上
- タスク管理方針や記法はAIエージェント向けガイダンスであり、人間はタスク内容のみ確認できれば十分

### マイグレーション手順

#### 手動マイグレーション

既存のplan.mdをバージョン5に移行する手順:

1. **TasksセクションのGitHub Issueガイダンスを移動**: 既存のAI向けガイダンスHTMLコメント（`<!-- 📝 Guidance for AI ... -->`）の中に、以下の内容を追加
   - "**GitHub Issueとの対応:**" 以降の説明（大きなタスク/小さなタスク/サブissue化検討中）
   - "**記法:**" 以降の記法説明（チェックボックスの意味）
2. **HTMLコメントを正しく閉じる**: 追加した内容の後に `-->` があることを確認
3. バージョンヘッダーを 5 に更新

**変更前:**
```markdown
## Tasks

<!--
📝 Guidance for AI
記入タイミング: before-planで初期タスク → before-poc以降で継続更新
記入内容: 実装者が「次に何をすべきか」を具体的に把握するための実行可能なタスクリスト
-->

**GitHub Issueとの対応:**
- **大きなタスク**（複数日、複数PR）→ サブissue化し`(#123)`形式でIssue番号を記載
- **小さなタスク**（1-2時間で完結）→ このissue内で管理、Issue番号なし
- **サブissue化検討中** → `(未Issue化)`と記載

**記法:**
- `- [ ] タスク名` - 未完了の小タスク
- `- [ ] タスク名 (#123)` - サブissueとして管理中
- `- [ ] タスク名 (未Issue化)` - サブissue化を検討中
- `- [x] タスク名` - 完了済みタスク

---

- [ ] [タスク1]
- [ ] [タスク2]
```

**変更後:**
```markdown
## Tasks

<!--
📝 Guidance for AI
記入タイミング: before-planで初期タスク → before-poc以降で継続更新
記入内容: 実装者が「次に何をすべきか」を具体的に把握するための実行可能なタスクリスト

**GitHub Issueとの対応:**
- **大きなタスク**（複数日、複数PR）→ サブissue化し`(#123)`形式でIssue番号を記載
- **小さなタスク**（1-2時間で完結）→ このissue内で管理、Issue番号なし
- **サブissue化検討中** → `(未Issue化)`と記載

**記法:**
- `- [ ] タスク名` - 未完了の小タスク
- `- [ ] タスク名 (#123)` - サブissueとして管理中
- `- [ ] タスク名 (未Issue化)` - サブissue化を検討中
- `- [x] タスク名` - 完了済みタスク
-->

- [ ] [タスク1]
- [ ] [タスク2]
```

**注意事項:**
- タスクリスト自体（`- [ ] [タスク1]`など）はHTMLコメント外に残す
- HTMLコメントの開始（`<!--`）と終了（`-->`）が正しく対応していることを確認

---

## マイグレーションツールの使用方法

### `/compact-plan` コマンド

`/compact-plan`コマンドは、plan.mdのバージョンをチェックし、必要に応じてマイグレーションをサポートします。

**動作:**
1. plan.mdのバージョンヘッダーを読み取り
2. 最新のplan-template.mdバージョンと比較
3. バージョンが古い場合、マイグレーション提案を表示
4. ユーザーの承認後、自動マイグレーションを実行

**実行例:**
```
/compact-plan

> ⚠️ plan.mdのバージョンが古い可能性があります
> 現在のバージョン: Version 1 (2025-10-15)
> 最新のバージョン: Version 3 (2025-11-01)
>
> マイグレーションが必要です。詳細はMIGRATION_GUIDE.mdを参照してください。
> マイグレーションを実行しますか？ (yes/no)
```

### 手動でのバージョン確認

plan.mdの先頭行を確認:
```markdown
<!-- Template Version: 1 (2025-10-15) -->
```

最新のplan-template.mdのバージョンと比較し、差異がある場合はこのガイドを参照してマイグレーションを実施してください。

---

## トラブルシューティング

### バージョンヘッダーがない場合

古いplan.mdにはバージョンヘッダーがない可能性があります。その場合:

1. plan.mdの先頭に以下を追加:
```markdown
<!-- Template Version: 1 (YYYY-MM-DD) -->
```

2. 現在のplan.mdの構造を確認し、最も近いバージョン番号を特定
3. 必要に応じてマイグレーションを実施

### マイグレーションの失敗

1. GitHub Issueのコメント履歴からバックアップを確認
2. 手動でマイグレーション手順を実施

---

## 更新履歴

- **Version 5 (2025-10-16)**: TasksセクションのGitHub Issue連携ガイダンスをHTMLコメント化
- **Version 4 (2025-10-15)**: issyncマーカーをテンプレートに追加
- **Version 3 (2025-10-15)**: 更新ガイドラインをHTMLコメント化
- **Version 2 (2025-10-15)**: Open Questions セクションのカテゴリ構造を削除
- **Version 1 (2025-10-15)**: 初期バージョン
